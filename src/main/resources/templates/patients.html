<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title th:text="${title}">Patient Management</title>
    <link rel="stylesheet" th:href="@{/css/style.css}">
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>üë• Patient Management</h1>
            <p>Manage patient records, registrations, and medical information</p>
        </div>

        <!-- Navigation Menu -->
        <nav class="nav-menu">
            <a href="/" class="nav-item">üè† Dashboard</a>
            <a href="/patients" class="nav-item active">üë• Patients</a>
            <a href="/doctors" class="nav-item">üë®‚Äç‚öïÔ∏è Doctors</a>
            <a href="/appointments" class="nav-item">üìÖ Appointments</a>
            <a href="/admin" class="nav-item">‚öôÔ∏è Admin</a>
        </nav>

        <!-- Actions -->
        <div class="card-grid">
            <div class="card">
                <h3>‚ûï Register New Patient</h3>
                <p>Add a new patient to the system with complete medical information.</p>
                <button onclick="showNewPatientForm()" class="btn">New Patient</button>
            </div>
            
            <div class="card">
                <h3>üîç Search Patients</h3>
                <p>Find patients by name, email, phone number, or medical record number.</p>
                <div class="form-group">
                    <input type="text" id="searchInput" class="form-input" placeholder="Search patients...">
                    <button onclick="searchPatients()" class="btn" style="margin-top: 10px;">Search</button>
                </div>
            </div>
        </div>

        <!-- Patient Form (Initially Hidden) -->
        <div id="patientForm" class="card" style="display: none;">
            <h3 id="formTitle">Register New Patient</h3>
            <form id="patientFormElement">
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px;">
                    <div class="form-group">
                        <label class="form-label">First Name *</label>
                        <input type="text" id="firstName" class="form-input" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Last Name *</label>
                        <input type="text" id="lastName" class="form-input" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Email *</label>
                        <input type="email" id="email" class="form-input" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Phone Number *</label>
                        <input type="tel" id="phoneNumber" class="form-input" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Date of Birth *</label>
                        <input type="date" id="dateOfBirth" class="form-input" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Gender *</label>
                        <select id="gender" class="form-input" required>
                            <option value="">Select Gender</option>
                            <option value="MALE">Male</option>
                            <option value="FEMALE">Female</option>
                            <option value="OTHER">Other</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Blood Type</label>
                        <select id="bloodType" class="form-input">
                            <option value="">Select Blood Type</option>
                            <option value="A+">A+</option>
                            <option value="A-">A-</option>
                            <option value="B+">B+</option>
                            <option value="B-">B-</option>
                            <option value="AB+">AB+</option>
                            <option value="AB-">AB-</option>
                            <option value="O+">O+</option>
                            <option value="O-">O-</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Emergency Contact Name</label>
                        <input type="text" id="emergencyContactName" class="form-input">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Emergency Contact Phone</label>
                        <input type="tel" id="emergencyContactPhone" class="form-input">
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Address</label>
                    <textarea id="address" class="form-input" rows="3" placeholder="Full address"></textarea>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Medical History</label>
                    <textarea id="medicalHistory" class="form-input" rows="4" placeholder="Previous medical conditions, surgeries, etc."></textarea>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Allergies</label>
                    <textarea id="allergies" class="form-input" rows="3" placeholder="Known allergies and reactions"></textarea>
                </div>
                
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button type="submit" class="btn">Save Patient</button>
                    <button type="button" onclick="cancelForm()" class="btn btn-secondary">Cancel</button>
                </div>
            </form>
        </div>

        <!-- Patient List -->
        <div id="patientList" class="table-container">
            <h3>üìã All Patients</h3>
            <div id="patientContent">
                <div class="spinner"></div>
            </div>
        </div>
    </div>

    <script>
        // Load patients on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadAllPatients();
            
            // Form submission handler
            document.getElementById('patientFormElement').addEventListener('submit', handleFormSubmit);
        });

        // Load all patients
        async function loadAllPatients() {
            const content = document.getElementById('patientContent');
            content.innerHTML = '<div class="spinner"></div>';
            
            try {
                const response = await axios.get('/api/patients');
                const patients = response.data;
                
                if (patients.length === 0) {
                    content.innerHTML = '<p>No patients found. Register your first patient above!</p>';
                    return;
                }
                
                let html = `
                    <table class="table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Name</th>
                                <th>Email</th>
                                <th>Phone</th>
                                <th>Date of Birth</th>
                                <th>Gender</th>
                                <th>Blood Type</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                
                patients.forEach(patient => {
                    html += `
                        <tr>
                            <td>${patient.patientId || 'N/A'}</td>
                            <td>${patient.firstName || ''} ${patient.lastName || ''}</td>
                            <td>${patient.email || 'N/A'}</td>
                            <td>${patient.phoneNumber || 'N/A'}</td>
                            <td>${patient.dateOfBirth || 'N/A'}</td>
                            <td>${patient.gender || 'N/A'}</td>
                            <td>${patient.bloodType || 'N/A'}</td>
                            <td>
                                <button class="btn" onclick="editPatient(${patient.patientId})" style="margin-right: 5px;">Edit</button>
                                <button class="btn btn-secondary" onclick="deletePatient(${patient.patientId})">Delete</button>
                            </td>
                        </tr>
                    `;
                });
                
                html += '</tbody></table>';
                content.innerHTML = html;
                
            } catch (error) {
                content.innerHTML = '<div class="alert alert-error">Error loading patients. Please try again.</div>';
                console.error('Error loading patients:', error);
            }
        }

        // Show new patient form
        function showNewPatientForm() {
            document.getElementById('formTitle').textContent = 'Register New Patient';
            document.getElementById('patientForm').style.display = 'block';
            document.getElementById('patientFormElement').reset();
            document.getElementById('patientForm').scrollIntoView({ behavior: 'smooth' });
        }

        // Cancel form
        function cancelForm() {
            document.getElementById('patientForm').style.display = 'none';
        }

        // Handle form submission
        async function handleFormSubmit(event) {
            event.preventDefault();
            
            const formData = {
                firstName: document.getElementById('firstName').value,
                lastName: document.getElementById('lastName').value,
                email: document.getElementById('email').value,
                phoneNumber: document.getElementById('phoneNumber').value,
                dateOfBirth: document.getElementById('dateOfBirth').value,
                gender: document.getElementById('gender').value,
                bloodType: document.getElementById('bloodType').value || null,
                emergencyContactName: document.getElementById('emergencyContactName').value || null,
                emergencyContactPhone: document.getElementById('emergencyContactPhone').value || null,
                address: document.getElementById('address').value || null,
                medicalHistory: document.getElementById('medicalHistory').value || null,
                allergies: document.getElementById('allergies').value || null,
                passwordHash: 'defaultPassword123' // Default password for new patients
            };
            
            try {
                const response = await axios.post('/api/patients', formData);
                
                if (response.status === 201 || response.status === 200) {
                    alert('Patient registered successfully!');
                    cancelForm();
                    loadAllPatients();
                } else {
                    alert('Error registering patient. Please try again.');
                }
                
            } catch (error) {
                console.error('Error saving patient:', error);
                alert('Error registering patient: ' + (error.response?.data?.message || error.message));
            }
        }

        // Search patients
        async function searchPatients() {
            const searchTerm = document.getElementById('searchInput').value.trim();
            
            if (!searchTerm) {
                loadAllPatients();
                return;
            }
            
            const content = document.getElementById('patientContent');
            content.innerHTML = '<div class="spinner"></div>';
            
            try {
                const response = await axios.get('/api/patients');
                const allPatients = response.data;
                
                // Simple client-side search
                const filteredPatients = allPatients.filter(patient => 
                    (patient.firstName && patient.firstName.toLowerCase().includes(searchTerm.toLowerCase())) ||
                    (patient.lastName && patient.lastName.toLowerCase().includes(searchTerm.toLowerCase())) ||
                    (patient.email && patient.email.toLowerCase().includes(searchTerm.toLowerCase())) ||
                    (patient.phoneNumber && patient.phoneNumber.includes(searchTerm))
                );
                
                if (filteredPatients.length === 0) {
                    content.innerHTML = '<p>No patients found matching your search.</p>';
                    return;
                }
                
                // Display filtered results (same table format as loadAllPatients)
                let html = `
                    <table class="table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Name</th>
                                <th>Email</th>
                                <th>Phone</th>
                                <th>Date of Birth</th>
                                <th>Gender</th>
                                <th>Blood Type</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                
                filteredPatients.forEach(patient => {
                    html += `
                        <tr>
                            <td>${patient.patientId || 'N/A'}</td>
                            <td>${patient.firstName || ''} ${patient.lastName || ''}</td>
                            <td>${patient.email || 'N/A'}</td>
                            <td>${patient.phoneNumber || 'N/A'}</td>
                            <td>${patient.dateOfBirth || 'N/A'}</td>
                            <td>${patient.gender || 'N/A'}</td>
                            <td>${patient.bloodType || 'N/A'}</td>
                            <td>
                                <button class="btn" onclick="editPatient(${patient.patientId})" style="margin-right: 5px;">Edit</button>
                                <button class="btn btn-secondary" onclick="deletePatient(${patient.patientId})">Delete</button>
                            </td>
                        </tr>
                    `;
                });
                
                html += '</tbody></table>';
                content.innerHTML = html;
                
            } catch (error) {
                content.innerHTML = '<div class="alert alert-error">Error searching patients. Please try again.</div>';
                console.error('Error searching patients:', error);
            }
        }

        // Edit patient (placeholder)
        function editPatient(id) {
            alert(`Edit patient ID: ${id}\n\nThis feature will be implemented to load patient data into the form for editing.`);
        }

        // Delete patient
        async function deletePatient(id) {
            if (!confirm('Are you sure you want to delete this patient? This action cannot be undone.')) {
                return;
            }
            
            try {
                await axios.delete(`/api/patients/${id}`);
                alert('Patient deleted successfully!');
                loadAllPatients();
            } catch (error) {
                console.error('Error deleting patient:', error);
                alert('Error deleting patient: ' + (error.response?.data?.message || error.message));
            }
        }
    </script>
</body>
</html>
